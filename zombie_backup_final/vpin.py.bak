# rtai/indicators/vpin.py
"""
VPIN Oscillator - Volume-Synchronized Probability of Informed Trading come RSI-like
=================================================================================

Trasforma VPIN in oscillatore 0-100 basato su z-score del suo scostamento.
"""

from rtai.indicators.filters import Oscillator
from rtai.config import INDICATORS

class VPINOsc:
    """VPIN trasformato in oscillatore RSI-like"""
    
    def __init__(self, **kwargs):
        # Usa parametri specifici per VPIN dalla config
        params = {**INDICATORS["vpin"], **kwargs}
        self.osc = Oscillator(**params)
        self.last_raw = 0.5

    def on_minute(self, vpin_1m):
        """
        Processa VPIN per minuto
        
        Args:
            vpin_1m: Stima VPIN per minuto (bucket per volume ma emessi 1/min)
            
        Returns:
            Dict con valori VPIN processati
        """
        if vpin_1m is None:
            vpin_1m = 0.5  # Neutrale se non disponibile
            
        # Centramento attorno 0.5 e scaling per z-score
        vpin_centered = (vpin_1m - 0.5) * 2.0  # -1..1
        
        self.last_raw = vpin_1m
        rsi_like, z, zf = self.osc.step(vpin_centered)
        
        return {
            "vpin_raw": vpin_1m,
            "vpin_centered": vpin_centered,
            "vpin_z": z,
            "vpin_zf": zf,
            "vpin_rsi": rsi_like,   # 0..100
        }
